<!DOCTYPE html>
<html lang="en">
<head>
    <title>Google maps api</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <style>
        .container {
            height: 100%;
            position: relative;
        }

        #pano {
            width: 200px;
            height: 200px;
        }
        #toggle-drawing {
            width: 32%;
            position: relative;
            margin-left: 10px;
        }
    </style>
    <link rel="stylesheet" href="assets/css/style.min.css">
</head>
<body>
<div class="wrapper">
    <header class="header">
        <section class="header__menu">
            <p class="header__menu">Menu</p>
        </section>
    </header>
    <div class="content">
        <aside class="sidebar js-sidebar">
            <div class="sidebar__content">
                <h1 class="sidebar__title">Find Your Omsk Home</h1>
                <div class="sidebar__form form">
                    <div class="form__input-container">
                        <input class="input" placeholder="">
                    </div>
                    <div class="form__button-container">
                        <button id="show-listings" class="button">Filter</button>
                    </div>
                    <!--<button type="button" id="hide-listings" class="button">Hide Listings</button>-->
                    <!--<hr/>-->
                    <!--<span class="text">Draw a shape to search within it for party</span>-->
                    <!--<button type="button" id="toggle-drawing">Drawing Tool</button>-->
                </div>
                <ul class="sidebar__list list">
                    <li class="list__item">asd</li>
                </ul>
            </div>
        </aside>
        <main class="main">
            <div id="map" class="map"></div>
        </main>
    </div>
</div>


<script>
  var map;
  var markers = [];
  var locations = [];
  var styles = [];
  var polygon = null;

  function initMap() {
    styles = [
      {elementType: 'geometry', stylers: [{color: '#7a757b'}]},
      {elementType: 'labels.text.stroke', stylers: [{color: '#242f3e'}]},
      {elementType: 'labels.text.fill', stylers: [{color: '#d7c2d2'}]},
      {
        featureType: 'administrative.locality',
        elementType: 'labels.text.fill',
        stylers: [{color: '#f0e9ee'}]
      },
      {
        featureType: 'poi',
        elementType: 'labels.text.fill',
        stylers: [{color: '#d3ccd5'}]
      },
      {
        featureType: 'poi.park',
        elementType: 'geometry',
        stylers: [{color: '#3c5842'}]
      },
      {
        featureType: 'poi.park',
        elementType: 'labels.text.fill',
        stylers: [{color: '#669a5c'}]
      },
      {
        featureType: 'road',
        elementType: 'geometry',
        stylers: [{color: '#ca9bd2'}]
      },
      {
        featureType: 'road',
        elementType: 'geometry.stroke',
        stylers: [{color: '#352937'}]
      },
      {
        featureType: 'road',
        elementType: 'labels.text.fill',
        stylers: [{color: '#dbdddd'}]
      },
      {
        featureType: 'road.highway',
        elementType: 'geometry',
        stylers: [{color: '#746855'}]
      },
      {
        featureType: 'road.highway',
        elementType: 'geometry.stroke',
        stylers: [{color: '#d48dc2'}]
      },
      {
        featureType: 'road.highway',
        elementType: 'labels.text.fill',
        stylers: [{color: '#f3d19c'}]
      },

      {
        featureType: 'water',
        elementType: 'geometry',
        stylers: [{color: '#9b8d9c'}]
      },
      {
        featureType: 'water',
        elementType: 'labels.text.fill',
        stylers: [{color: '#8d7985'}]
      },
      {
        featureType: 'water',
        elementType: 'labels.text.stroke',
        stylers: [{color: '#a18a98'}]
      }
    ];


    locations = [
      {title: 'V dome Aktera', location: {lat: 54.976462, lng: 73.382644}},
      {title: 'Liberov-center', location: {lat: 54.983786, lng: 73.382723}},
      {title: 'Hospital', location: {lat: 54.979758, lng: 73.375631}},
      {title: 'Cadet corp', location: {lat: 54.977763, lng: 73.37771}}
    ];

    map = new google.maps.Map(document.getElementById('map'), {
      center: {lat: 54.98848, lng: 73.3242361},
      zoom: 13,
      mapTypeControl: false,
      styles: styles
    });

    var largeInfowindow = new google.maps.InfoWindow();
    var defaultIcon = makeMarkerIcon('0091ff');
    var highlightedIcon = makeMarkerIcon('f3d19c');


    var drawingManager = new google.maps.drawing.DrawingManager({
      drawingMode: google.maps.drawing.OverlayType.POLYGON,
      drawingControl: true,
      drawingControlOptions: {
        position: google.maps.ControlPosition.TOP_LEFT,
        drawingModes: ['polygon']
      }
    });


    for (var i = 0; i < locations.length; i++) {
      var position = locations[i].location;
      var title = locations[i].title;

      var marker = new google.maps.Marker({
        position: position,
        title: title,
        id: i,
        draggable: true,
        animation: google.maps.Animation.DROP,
        icon: defaultIcon
      });

      markers.push(marker);

      marker.addListener('click', function () {
        populateInfoWindow(this, largeInfowindow);
      });
      marker.addListener('mouseover', function () {
        this.setIcon(highlightedIcon);
      });
      marker.addListener('mouseout', function () {
        this.setIcon(defaultIcon);
      });
    }

    document.getElementById('show-listings').addEventListener('click', showListings);
//    document.getElementById('hide-listings').addEventListener('click', hideListings);
//    document.getElementById('toggle-drawing').addEventListener('click', function () {
//      toggleDrawing(drawingManager);
//    });

    drawingManager.addListener('overlaycomplete', function (event) {
      if (polygon) {
        polygon.setMap(null);
        hideListings(markers);
      }

      drawingManager.setDrawingMode(null);

      polygon = event.overlay;
      polygon.setEditable(true);

      searchWithinPolygon();

      polygon.getPath().addListener('set_at', searchWithinPolygon);
      polygon.getPath().addListener('insert_at', searchWithinPolygon);

      var area = google.maps.geometry.spherical.computeArea(polygon.getPath());
      alert(area + ' square meters');
      console.log(area);
    });
  }

  function populateInfoWindow(marker, infowindow) {
    if (infowindow.marker != marker) {
      infowindow.marker = marker;
      infowindow.setContent('<div>' + marker.position + '</div>');

      infowindow.addListener('closeclick', function () {
        infowindow.marker = null;
      });

      var streetViewService = new google.maps.StreetViewService();
      var radius = 50;

      function getStreetView(data, status) {
        if (status == google.maps.StreetViewStatus.OK) {
          var nearStreetViewLocation = data.location.latLng;
          var heading = google.maps.geometry.spherical.computeHeading(nearStreetViewLocation, marker.position);

          infowindow.setContent('<div class="text">' + marker.title + '</div><div id="pano"></div>');

          var panoramaOptions = {
            position: nearStreetViewLocation,
            pov: {
              heading: heading,
              pitch: 30
            }
          };
          var panorama = new google.maps.StreetViewPanorama(document.getElementById('pano'), panoramaOptions);
        } else {
          infowindow.setContent('<div class="text">' + marker.title + '</div>' +
            '<div>No Street View Found</div>');
        }
      }

      streetViewService.getPanoramaByLocation(marker.position, radius, getStreetView);

      infowindow.open(map, marker);
    }
  }

  function showListings() {
    var bounds = new google.maps.LatLngBounds();
    for (var i = 0; i < markers.length; i++) {
      markers[i].setMap(map);
      bounds.extend(markers[i].position);
    }

    map.fitBounds(bounds);
  }

  function hideListings() {
    for (var i = 0; i < markers.length; i++) {
      markers[i].setMap(null);
    }
  }

  function makeMarkerIcon(markerColor) {
    var markerImage = new google.maps.MarkerImage(
      'http://chart.googleapis.com/chart?chst=d_map_spin&chld=1.15|0|' + markerColor +
      '|40|_|%E2%80%A2',
      new google.maps.Size(21, 34),
      new google.maps.Point(0, 0),
      new google.maps.Point(10, 34),
      new google.maps.Size(21, 34));
    return markerImage;
  }

  function toggleDrawing(drawingManager) {
    if (drawingManager.map) {
      drawingManager.setMap(null);

      if (polygon !== null) {
        polygon.setMap(null);
      }
    } else {
      drawingManager.setMap(map);
    }
  }

  function searchWithinPolygon() {
    for (var i = 0; i < markers.length; i++) {
      if (google.maps.geometry.poly.containsLocation(markers[i].position, polygon)) {
        markers[i].setMap(map);
      } else {
        markers[i].setMap(null);
      }
    }
  }

</script>
<script src="https://maps.googleapis.com/maps/api/js?libraries=geometry,drawing&key=AIzaSyA06zneEbM7ThTAoisy3cXHfuzRzRUHZSE&callback=initMap"
        async defer></script>

</body>
</html>